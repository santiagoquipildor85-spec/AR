<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR C√≥digos QR - Textos Personalizados</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #000;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .camera-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .qr-detection {
            position: absolute;
            border: 3px solid #00ff00;
            border-radius: 10px;
            animation: pulse 1.5s infinite;
        }

        .ar-message {
            position: absolute;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            max-width: 300px;
            word-wrap: break-word;
            transform: translateX(-50%);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { border-color: #00ff00; transform: scale(1); }
            50% { border-color: #00ff88; transform: scale(1.05); }
            100% { border-color: #00ff00; transform: scale(1); }
        }

        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .status {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <button class="back-button" onclick="window.location.href='index.html'">‚Üê Volver</button>
    
    <div class="status" id="status">Iniciando c√°mara...</div>
    
    <div class="instructions">
        üì± Apunta a un c√≥digo QR para ver el mensaje
    </div>

    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="ar-overlay" id="arOverlay"></div>
    </div>

    <!-- Biblioteca QR Scanner -->
    <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

    <script>
        class ARQRScanner {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.arOverlay = document.getElementById('arOverlay');
                this.status = document.getElementById('status');
                
                this.codeReader = new ZXing.BrowserQRCodeReader();
                this.isScanning = false;
                this.lastDetection = null;
                this.detectionTimeout = null;
                
                // Mensajes configurados
                this.messages = {
                    'QR1': 'üëã ¬°Hola!\nBienvenido a DAyE 2025 Expo',
                    'QR2': 'üöÄ Innovaci√≥n\nen Tecnolog√≠a',
                    'QR3': 'üéØ Realidad Aumentada\nen Acci√≥n',
                    'QR4': 'üí° El Futuro\nEs Ahora',
                    'QR5': 'üåü Experiencia\nInteractiva',
                    'QR6': 'üîÆ Magia Digital\nDAyE 2025',
                    // Tambi√©n acepta n√∫meros simples
                    '1': 'üëã ¬°Hola!\nBienvenido a DAyE 2025 Expo',
                    '2': 'üöÄ Innovaci√≥n\nen Tecnolog√≠a',
                    '3': 'üéØ Realidad Aumentada\nen Acci√≥n',
                    '4': 'üí° El Futuro\nEs Ahora',
                    '5': 'üåü Experiencia\nInteractiva',
                    '6': 'üîÆ Magia Digital\nDAyE 2025'
                };
                
                this.init();
            }

            async init() {
                try {
                    await this.startCamera();
                    this.setupCanvas();
                    this.startScanning();
                    this.updateStatus('üîç Buscando c√≥digos QR...');
                } catch (error) {
                    console.error('Error:', error);
                    this.updateStatus('‚ùå Error al acceder a la c√°mara');
                }
            }

            async startCamera() {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.addEventListener('loadedmetadata', () => {
                            setTimeout(() => {
                                this.setupCanvas();
                                resolve();
                            }, 500);
                        });
                    });
                } catch (error) {
                    throw new Error('No se pudo acceder a la c√°mara: ' + error.message);
                }
            }

            setupCanvas() {
                this.canvas.width = this.video.videoWidth || 1280;
                this.canvas.height = this.video.videoHeight || 720;
            }

            startScanning() {
                this.isScanning = true;
                this.scanLoop();
            }

            async scanLoop() {
                if (!this.isScanning) return;

                try {
                    if (this.video.videoWidth > 0) {
                        // Dibujar frame actual
                        this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                        
                        // Intentar detectar QR
                        const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                        await this.detectQR(imageData);
                    }
                } catch (error) {
                    console.log('Escaneando...'); // Normal durante la b√∫squeda
                }

                if (this.isScanning) {
                    requestAnimationFrame(() => this.scanLoop());
                }
            }

            async detectQR(imageData) {
                try {
                    // Crear canvas temporal para ZXing
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = imageData.width;
                    tempCanvas.height = imageData.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.putImageData(imageData, 0, 0);

                    // Intentar decodificar QR
                    const result = await this.codeReader.decodeFromCanvas(tempCanvas);
                    
                    if (result && result.text) {
                        this.handleQRDetection(result.text, result.resultPoints);
                    }
                } catch (error) {
                    // No se detect√≥ QR, continuar escaneando
                    this.clearDetection();
                }
            }

            handleQRDetection(qrText, resultPoints) {
                const message = this.messages[qrText] || this.messages[qrText.toUpperCase()];
                
                if (message) {
                    // Calcular posici√≥n del QR
                    let centerX = 0, centerY = 0;
                    if (resultPoints && resultPoints.length > 0) {
                        resultPoints.forEach(point => {
                            centerX += point.x;
                            centerY += point.y;
                        });
                        centerX = (centerX / resultPoints.length) * (this.video.offsetWidth / this.canvas.width);
                        centerY = (centerY / resultPoints.length) * (this.video.offsetHeight / this.canvas.height);
                    } else {
                        centerX = this.video.offsetWidth / 2;
                        centerY = this.video.offsetHeight / 2;
                    }

                    this.showARMessage(message, centerX, centerY);
                    this.updateStatus(`‚úÖ QR detectado: ${qrText}`);
                    
                    // Limpiar despu√©s de 3 segundos
                    if (this.detectionTimeout) {
                        clearTimeout(this.detectionTimeout);
                    }
                    this.detectionTimeout = setTimeout(() => {
                        this.clearDetection();
                        this.updateStatus('üîç Buscando c√≥digos QR...');
                    }, 3000);
                }
            }

            showARMessage(message, x, y) {
                // Limpiar mensajes anteriores
                this.arOverlay.innerHTML = '';

                // Crear borde de detecci√≥n
                const border = document.createElement('div');
                border.className = 'qr-detection';
                border.style.left = (x - 75) + 'px';
                border.style.top = (y - 75) + 'px';
                border.style.width = '150px';
                border.style.height = '150px';

                // Crear mensaje flotante
                const messageEl = document.createElement('div');
                messageEl.className = 'ar-message';
                messageEl.innerHTML = message.replace(/\n/g, '<br>');
                
                // Posicionar mensaje arriba del QR
                messageEl.style.left = x + 'px';
                messageEl.style.top = (y - 120) + 'px';

                this.arOverlay.appendChild(border);
                this.arOverlay.appendChild(messageEl);
            }

            clearDetection() {
                this.arOverlay.innerHTML = '';
            }

            updateStatus(text) {
                this.status.textContent = text;
            }

            stop() {
                this.isScanning = false;
                if (this.video.srcObject) {
                    const tracks = this.video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
            }
        }

        // Iniciar cuando la p√°gina cargue
        let scanner;
        document.addEventListener('DOMContentLoaded', () => {
            scanner = new ARQRScanner();
        });

        // Limpiar al salir
        window.addEventListener('beforeunload', () => {
            if (scanner) scanner.stop();
        });

        // Mantener pantalla activa
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(err => {
                console.log('Wake lock no disponible:', err);
            });
        }
    </script>
</body>
</html>
