<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realidad Aumentada - Detector de Formas</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="ar-styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body class="ar-body">
    <div class="ar-container-fullscreen">
        <!-- Botón de cerrar minimalista -->
        <button id="backBtn" class="btn-close">×</button>
        
        <!-- Cámara fullscreen -->
        <div class="camera-fullscreen">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="ar-overlay" id="arOverlay"></div>
        </div>

        <!-- Indicador de estado minimalista -->
        <div class="status-indicator" id="statusIndicator">
            <div class="status-dot"></div>
            <span id="statusText">Toca para iniciar</span>
        </div>
    </div>

    <script>
        // Sistema AR simplificado y funcional
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando AR...');
            
            // Variables
            let isRunning = false;
            let stream = null;
            let animationId = null;
            
            // Elementos
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const arOverlay = document.getElementById('arOverlay');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusDot = document.querySelector('.status-dot');
            const backBtn = document.getElementById('backBtn');
            
            // Función para actualizar estado
            function updateStatus(text, state) {
                if (statusText) statusText.textContent = text;
                if (statusDot) {
                    statusDot.className = 'status-dot';
                    if (state === 'active') statusDot.classList.add('active');
                    if (state === 'detecting') statusDot.classList.add('detecting');
                }
            }
            
            // Configurar canvas
            function setupCanvas() {
                if (video.videoWidth && video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                }
            }
            
            // Limpiar overlay
            function clearOverlay() {
                while (arOverlay.firstChild) {
                    arOverlay.removeChild(arOverlay.firstChild);
                }
            }
            
            // Mostrar detección de prueba
            function showDetection() {
                const card = document.createElement('div');
                card.style.position = 'absolute';
                card.style.left = '50%';
                card.style.top = '30%';
                card.style.transform = 'translateX(-50%)';
                card.style.background = 'rgba(46, 204, 113, 0.9)';
                card.style.color = 'white';
                card.style.padding = '12px 16px';
                card.style.borderRadius = '8px';
                card.style.fontFamily = 'Arial, sans-serif';
                card.style.zIndex = '10';
                card.style.textAlign = 'center';
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                
                card.innerHTML = '<div style="font-weight: bold; margin-bottom: 2px;">👋 Hola</div><div style="font-size: 12px;">DAyE 2025 Expo</div>';
                
                arOverlay.appendChild(card);
                
                setTimeout(function() {
                    if (card.parentNode) {
                        card.parentNode.removeChild(card);
                    }
                }, 3000);
                
                updateStatus('¡Detectado!', 'detecting');
            }
            
            // Loop de detección
            function detectLoop() {
                if (!isRunning) return;
                
                try {
                    if (video.videoWidth > 0) {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Simulación de detección cada 5 segundos aprox
                        if (Math.random() > 0.995) {
                            showDetection();
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
                
                if (isRunning) {
                    animationId = requestAnimationFrame(detectLoop);
                }
            }
            
            // Iniciar AR
            async function startAR() {
                try {
                    updateStatus('Iniciando...', 'detecting');
                    
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    video.srcObject = stream;
                    
                    video.onloadedmetadata = function() {
                        setupCanvas();
                        isRunning = true;
                        updateStatus('Detectando...', 'active');
                        detectLoop();
                    };
                    
                } catch (error) {
                    console.error('Error:', error);
                    updateStatus('Error de cámara', 'ready');
                }
            }
            
            // Detener AR
            function stopAR() {
                isRunning = false;
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                if (video.srcObject) {
                    video.srcObject = null;
                }
                
                clearOverlay();
                updateStatus('Toca para iniciar', 'ready');
            }
            
            // Toggle AR
            function toggleAR() {
                if (isRunning) {
                    stopAR();
                } else {
                    startAR();
                }
            }
            
            // Event listeners
            statusIndicator.addEventListener('click', toggleAR);
            
            backBtn.addEventListener('click', function() {
                stopAR();
                window.location.href = 'index.html';
            });
            
            // Configuración inicial
            updateStatus('Toca para iniciar', 'ready');
            console.log('AR listo');
        });
    </script>
</body>
</html>
