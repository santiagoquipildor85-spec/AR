<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realidad Aumentada - Detector de Formas</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="ar-styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
    </style>
</head>
<body class="ar-body">
    <div class="ar-container-fullscreen">
        <!-- Botón de cerrar minimalista -->
        <button id="backBtn" class="btn-close">×</button>
        
        <!-- Cámara fullscreen -->
        <div class="camera-fullscreen">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="ar-overlay" id="arOverlay"></div>
        </div>

        <!-- Indicador de estado minimalista -->
        <div class="status-indicator" id="statusIndicator">
            <div class="status-dot"></div>
            <span id="statusText">Toca para iniciar</span>
        </div>
    </div>

    <script>
        // Sistema AR simplificado y funcional
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando AR...');
            
            // Variables
            let isRunning = false;
            let stream = null;
            let animationId = null;
            
            // Elementos
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const arOverlay = document.getElementById('arOverlay');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusDot = document.querySelector('.status-dot');
            const backBtn = document.getElementById('backBtn');
            
            // Función para actualizar estado
            function updateStatus(text, state) {
                if (statusText) statusText.textContent = text;
                if (statusDot) {
                    statusDot.className = 'status-dot';
                    if (state === 'active') statusDot.classList.add('active');
                    if (state === 'detecting') statusDot.classList.add('detecting');
                }
            }
            
            // Configurar canvas
            function setupCanvas() {
                if (video.videoWidth && video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                }
            }
            
            // Limpiar overlay
            function clearOverlay() {
                while (arOverlay.firstChild) {
                    arOverlay.removeChild(arOverlay.firstChild);
                }
            }
            
            // Mostrar detección en posición específica
            function showDetectionAt(x, y, width, height) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = rect.width / canvas.width;
                const scaleY = rect.height / canvas.height;
                
                // Borde de detección
                const border = document.createElement('div');
                border.style.position = 'absolute';
                border.style.left = (x * scaleX) + 'px';
                border.style.top = (y * scaleY) + 'px';
                border.style.width = (width * scaleX) + 'px';
                border.style.height = (height * scaleY) + 'px';
                border.style.border = '3px solid #2ecc71';
                border.style.borderRadius = '4px';
                border.style.zIndex = '5';
                border.style.animation = 'pulse 1s infinite';
                
                // Texto flotante
                const card = document.createElement('div');
                card.style.position = 'absolute';
                card.style.left = ((x + width + 10) * scaleX) + 'px';
                card.style.top = (y * scaleY) + 'px';
                card.style.background = 'rgba(46, 204, 113, 0.9)';
                card.style.color = 'white';
                card.style.padding = '8px 12px';
                card.style.borderRadius = '6px';
                card.style.fontFamily = 'Arial, sans-serif';
                card.style.fontSize = '14px';
                card.style.zIndex = '10';
                card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                card.style.whiteSpace = 'nowrap';
                
                card.innerHTML = '<div style="font-weight: bold; margin-bottom: 2px;">👋 Hola</div><div style="font-size: 11px; opacity: 0.9;">DAyE 2025 Expo</div>';
                
                arOverlay.appendChild(border);
                arOverlay.appendChild(card);
            }
            
            // Loop de detección real
            function detectLoop() {
                if (!isRunning) return;
                
                try {
                    if (video.videoWidth > 0) {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Detectar forma L real
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const detections = detectLShape(imageData);
                        
                        // Limpiar detecciones anteriores
                        clearOverlay();
                        
                        // Mostrar detecciones encontradas
                        if (detections.length > 0) {
                            detections.forEach(detection => {
                                showDetectionAt(detection.x, detection.y, detection.width, detection.height);
                            });
                            updateStatus('¡Forma L detectada!', 'detecting');
                        } else {
                            updateStatus('Buscando forma L...', 'active');
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
                
                if (isRunning) {
                    animationId = requestAnimationFrame(detectLoop);
                }
            }
            
            // Detectar forma L específica
            function detectLShape(imageData) {
                const detections = [];
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                // Convertir a escala de grises y binarizar
                const gray = new Uint8Array(width * height);
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const grayscale = (r + g + b) / 3;
                    gray[i / 4] = grayscale > 128 ? 255 : 0; // Umbral para blanco/negro
                }
                
                // Buscar regiones blancas (forma L)
                const step = 20; // Reducir carga computacional
                for (let y = step; y < height - 100; y += step) {
                    for (let x = step; x < width - 100; x += step) {
                        const region = analyzeRegion(gray, width, height, x, y, 80, 80);
                        if (region.isLShape) {
                            detections.push({
                                x: x,
                                y: y,
                                width: 80,
                                height: 80,
                                confidence: region.confidence
                            });
                        }
                    }
                }
                
                // Filtrar detecciones superpuestas
                return filterOverlapping(detections);
            }
            
            // Analizar región específica para forma L
            function analyzeRegion(gray, width, height, startX, startY, regionWidth, regionHeight) {
                let whitePixels = 0;
                let totalPixels = 0;
                let lPattern = 0;
                
                // Analizar patrón de la región
                for (let y = 0; y < regionHeight; y += 4) {
                    for (let x = 0; x < regionWidth; x += 4) {
                        const pixelX = startX + x;
                        const pixelY = startY + y;
                        
                        if (pixelX < width && pixelY < height) {
                            const index = pixelY * width + pixelX;
                            totalPixels++;
                            
                            if (gray[index] === 255) { // Píxel blanco
                                whitePixels++;
                                
                                // Verificar patrón L específico
                                if (isInLPattern(x, y, regionWidth, regionHeight)) {
                                    lPattern++;
                                }
                            }
                        }
                    }
                }
                
                const density = whitePixels / totalPixels;
                const lRatio = lPattern / whitePixels;
                
                // Criterios para forma L
                const isLShape = density > 0.3 && density < 0.7 && lRatio > 0.6;
                const confidence = (density * 0.5 + lRatio * 0.5);
                
                return { isLShape, confidence };
            }
            
            // Verificar si el píxel está en patrón L
            function isInLPattern(x, y, width, height) {
                const centerX = width / 2;
                const centerY = height / 2;
                
                // Forma L: parte vertical (izquierda) y horizontal (abajo)
                const inVertical = x < centerX && y > centerY * 0.3;
                const inHorizontal = y > centerY && x < centerX * 1.7;
                
                return inVertical || inHorizontal;
            }
            
            // Filtrar detecciones superpuestas
            function filterOverlapping(detections) {
                const filtered = [];
                const minDistance = 60;
                
                detections.sort((a, b) => b.confidence - a.confidence);
                
                for (const detection of detections) {
                    let isOverlapping = false;
                    
                    for (const existing of filtered) {
                        const distance = Math.sqrt(
                            Math.pow(detection.x - existing.x, 2) + 
                            Math.pow(detection.y - existing.y, 2)
                        );
                        
                        if (distance < minDistance) {
                            isOverlapping = true;
                            break;
                        }
                    }
                    
                    if (!isOverlapping && detection.confidence > 0.4) {
                        filtered.push(detection);
                    }
                }
                
                return filtered.slice(0, 3); // Máximo 3 detecciones
            }
            
            // Iniciar AR
            async function startAR() {
                try {
                    updateStatus('Iniciando...', 'detecting');
                    
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    video.srcObject = stream;
                    
                    video.onloadedmetadata = function() {
                        setupCanvas();
                        isRunning = true;
                        updateStatus('Detectando...', 'active');
                        detectLoop();
                    };
                    
                } catch (error) {
                    console.error('Error:', error);
                    updateStatus('Error de cámara', 'ready');
                }
            }
            
            // Detener AR
            function stopAR() {
                isRunning = false;
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                if (video.srcObject) {
                    video.srcObject = null;
                }
                
                clearOverlay();
                updateStatus('Toca para iniciar', 'ready');
            }
            
            // Toggle AR
            function toggleAR() {
                if (isRunning) {
                    stopAR();
                } else {
                    startAR();
                }
            }
            
            // Event listeners
            statusIndicator.addEventListener('click', toggleAR);
            
            backBtn.addEventListener('click', function() {
                stopAR();
                window.location.href = 'index.html';
            });
            
            // Configuración inicial
            updateStatus('Toca para iniciar', 'ready');
            console.log('AR listo');
        });
    </script>
</body>
</html>
